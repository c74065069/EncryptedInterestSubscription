<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Required for Relayer WASM workers -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin"/>
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp"/>

  <title>Secret Bonus Payout · Zama FHEVM</title>

  <!-- Fonts: bold, readable brutalist combo -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Spline+Sans+Mono:wght@400;600&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#fafafa; --ink:#0b0b0b; --muted:#5b5b5b; --line:#0b0b0b;
      --accent:#0ea5a3; --accent2:#2563eb; --warn:#b45309; --ok:#166534; --err:#b91c1c;
      --radius: 10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    header{
      border-bottom: 2px solid var(--line);
      padding: 14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:flex-end; gap:10px}
    .logo{
      width:42px; height:42px; border:2px solid var(--line); border-radius:6px; display:grid; place-items:center;
      font-weight:800; letter-spacing:.5px;
    }
    h1{margin:0; font-size:18px; font-weight:800; letter-spacing:.2px}
    .sub{font-size:12px; color:var(--muted); font-weight:600}
    .chip{
      border:2px solid var(--line); background:#fff; padding:8px 12px; border-radius: 999px; font-weight:800; cursor:pointer;
    }
    .chip:disabled{opacity:.6; cursor:not-allowed}
    main{max-width:1180px; margin: 24px auto 80px; padding: 0 12px}
    .banner{
      border:2px solid var(--line); border-radius: var(--radius);
      padding:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      background:#fff;
    }
    .mono{ font-family: "Spline Sans Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .pill{ border:2px solid var(--line); padding:6px 10px; border-radius: 999px; font-weight:800; background:#fff }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    .card{
      border:2px solid var(--line); border-radius: var(--radius); background:#fff; padding:14px;
    }
    .card h2{ margin:0 0 8px; font-size:16px; font-weight:800 }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    label{ font-size:12px; font-weight:800; letter-spacing:.03em; text-transform:uppercase; color:#222 }
    input{
      width:100%; padding:12px 12px; border:2px solid var(--line); border-radius:8px; background:#fff; color:#111; font-weight:800;
      outline:none;
    }
    input:focus{ box-shadow: 4px 4px 0 #000; }
    .two{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .btn{
      border:2px solid var(--line); background:#fff; padding:12px 14px; border-radius:8px; font-weight:800; cursor:pointer;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.primary{ background:#e6fffb; border-color:#000; }
    .btn.alt{ background:#eef2ff; }
    .btn.warn{ background:#fff7ed; }
    .status{
      border:2px dashed var(--line); border-radius:8px; padding:10px; font:600 12px Inter; color:#222; background:#fff; word-break:break-all;
      margin-top:10px;
    }
    .status.ok{ border-style:solid; color:#0f5132; background:#d1fae5 }
    .status.err{ border-style:solid; color:#7f1d1d; background:#fee2e2 }
    .big{
      font-size:22px; font-weight:800; letter-spacing:-.02em; border:2px solid var(--line); padding:10px 12px; border-radius:10px; background:#fff;
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">FHE</div>
    <div>
      <h1>Secret Bonus Payout</h1>
      <div class="sub">Encrypted KPIs → Encrypted bonus (only the employee can decrypt)</div>
    </div>
  </div>
  <div class="row">
    <span id="netTag" class="pill mono">Network: —</span>
    <button id="btnConnect" class="chip">Connect Wallet</button>
  </div>
</header>

<main>
  <section class="banner">
    <span class="pill mono">Contract</span>
    <span id="addr" class="pill mono">0x13274eA87Db740ca19f1d85B8c0c6aDf90a0a4EB</span>
    <span class="pill mono">Relayer SDK 0.2.0</span>
    <span class="pill mono">Ethers v6</span>
  </section>

  <section class="grid">
    <!-- Employee panel -->
    <article class="card">
      <h2>Employee · Request Private Bonus</h2>
      <div class="two">
        <div>
          <label>Quality (0..255)</label>
          <input id="q" type="number" min="0" max="255" placeholder="e.g. 90"/>
        </div>
        <div>
          <label>Velocity (0..255)</label>
          <input id="v" type="number" min="0" max="255" placeholder="e.g. 85"/>
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Impact (0..255)</label>
        <input id="i" type="number" min="0" max="255" placeholder="e.g. 80"/>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnEval" class="btn primary">Submit Encrypted KPIs</button>
        <span id="empTx" class="pill mono">—</span>
      </div>
      <div id="empLog" class="status">—</div>
      <div style="margin-top:10px" class="row">
        <span class="big mono" id="bonusOut">$ —</span>
      </div>
    </article>

    <!-- Admin panel -->
    <article class="card">
      <h2>Admin · Encrypted Policy</h2>
      <div class="two">
        <div>
          <label>minQuality (u8)</label>
          <input id="minQ" type="number" min="0" max="255" placeholder="e.g. 80"/>
        </div>
        <div>
          <label>minVelocity (u8)</label>
          <input id="minV" type="number" min="0" max="255" placeholder="e.g. 80"/>
        </div>
      </div>
      <div class="two" style="margin-top:10px">
        <div>
          <label>minImpact (u8)</label>
          <input id="minI" type="number" min="0" max="255" placeholder="e.g. 75"/>
        </div>
        <div>
          <label>bonusYes (u32)</label>
          <input id="bYes" type="number" min="0" max="4294967295" placeholder="e.g. 5000"/>
        </div>
      </div>
      <div style="margin-top:10px">
        <label>bonusNo (u32)</label>
        <input id="bNo" type="number" min="0" max="4294967295" placeholder="e.g. 500"/>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnSetEnc" class="btn primary">Set Encrypted Policy</button>
        <button id="btnSetPlain" class="btn alt">Set Plain (dev)</button>
        <button id="btnPublic" class="btn warn">Make Policy Public</button>
      </div>
      <div id="admLog" class="status">—</div>

      <div style="margin-top:10px">
        <label>Policy handles</label>
        <div id="handles" class="status mono" style="white-space:pre-wrap">—</div>
      </div>
    </article>
  </section>
</main>

<!-- SDKs (ESM) -->
<script type="module" crossorigin src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js"></script>
<script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm"></script>

<script type="module">
  import { BrowserProvider, Contract } from "https://cdn.jsdelivr.net/npm/ethers@6.13.4/+esm";
  import { initSDK, createInstance, SepoliaConfig, generateKeypair } from "https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js";

  // ===== Config =====
  const CONTRACT_ADDRESS = "0x13274eA87Db740ca19f1d85B8c0c6aDf90a0a4EB";
  const RELAYER_URL = "https://relayer.testnet.zama.cloud";
  const CHAIN_ID_HEX = "0xaa36a7"; // Sepolia

  // ABI subset — SecretBonusPayout
  const abi = [
    { type:"function", name:"version", inputs:[], outputs:[{type:"string"}], stateMutability:"pure" },

    { type:"function", name:"setPolicyEncrypted", inputs:[
      {type:"bytes32"}, {type:"bytes32"}, {type:"bytes32"}, {type:"bytes32"}, {type:"bytes32"}, {type:"bytes"}
    ], outputs:[], stateMutability:"nonpayable" },

    { type:"function", name:"setPolicyPlain", inputs:[
      {type:"uint8"},{type:"uint8"},{type:"uint8"},{type:"uint32"},{type:"uint32"}
    ], outputs:[], stateMutability:"nonpayable" },

    { type:"function", name:"getPolicyHandles", inputs:[], outputs:[
      {type:"bytes32"},{type:"bytes32"},{type:"bytes32"},{type:"bytes32"},{type:"bytes32"},{type:"bool"}
    ], stateMutability:"view" },

    { type:"function", name:"makePolicyPublic", inputs:[], outputs:[], stateMutability:"nonpayable" },

    { type:"function", name:"evaluateKPIs", inputs:[
      {type:"bytes32"}, {type:"bytes32"}, {type:"bytes32"}, {type:"bytes"}
    ], outputs:[{type:"bytes32"}], stateMutability:"nonpayable" },

    { type:"event", name:"PolicyUpdated", inputs:[
      {indexed:false, name:"minQualityH", type:"bytes32"},
      {indexed:false, name:"minVelocityH", type:"bytes32"},
      {indexed:false, name:"minImpactH", type:"bytes32"},
      {indexed:false, name:"bonusYesH", type:"bytes32"},
      {indexed:false, name:"bonusNoH", type:"bytes32"}
    ]},
    { type:"event", name:"BonusComputed", inputs:[
      {indexed:true, name:"employee", type:"address"},
      {indexed:false, name:"bonusHandle", type:"bytes32"}
    ]},
  ];

  // ===== Elements =====
  const $ = (id)=>document.getElementById(id);
  const els = {
    netTag: $("netTag"), btnConnect: $("btnConnect"), addr: $("addr"),
    // employee
    q: $("q"), v: $("v"), i: $("i"), btnEval: $("btnEval"), empLog: $("empLog"), empTx: $("empTx"), bonusOut: $("bonusOut"),
    // admin
    minQ: $("minQ"), minV: $("minV"), minI: $("minI"), bYes: $("bYes"), bNo: $("bNo"),
    btnSetEnc: $("btnSetEnc"), btnSetPlain: $("btnSetPlain"), btnPublic: $("btnPublic"),
    admLog: $("admLog"), handles: $("handles"),
  };
  els.addr.textContent = CONTRACT_ADDRESS;

  // ===== State =====
  let provider, signer, user, contract, relayer;

  // ===== Helpers =====
  const info = (el, t)=>{ el.className="status"; el.textContent=t; };
  const ok   = (el, t)=>{ el.className="status ok"; el.textContent=t; };
  const err  = (el, t)=>{ el.className="status err"; el.textContent=t; };
  const isU8  = (n)=>Number.isInteger(n) && n>=0 && n<=255;
  const isU32 = (n)=>Number.isInteger(n) && n>=0 && n<=4294967295;
  const short = (a)=>a ? a.slice(0,6)+"…"+a.slice(-4) : "—";

  // ===== Connect =====
  els.btnConnect.onclick = async ()=>{
    try{
      if(!window.ethereum) throw new Error("MetaMask not found");
      provider = new BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      const net = await provider.getNetwork();
      els.netTag.textContent = net.chainId===11155111n ? "Network: Sepolia" : `Network: ${String(net.chainId)}`;
      if(net.chainId !== 11155111n){
        await provider.send("wallet_switchEthereumChain", [{ chainId: CHAIN_ID_HEX }]);
      }
      signer = await provider.getSigner();
      user = await signer.getAddress();
      contract = new Contract(CONTRACT_ADDRESS, abi, signer);
      els.btnConnect.textContent = short(user);

      info(els.admLog, "Bootstrapping Relayer…");
      await initSDK();
      relayer = await createInstance({ ...SepoliaConfig, relayerUrl: RELAYER_URL, network: window.ethereum, debug: true });
      ok(els.admLog, "Relayer ready ✓");

      // Try to read policy handles
      try{
        const h = await contract.getPolicyHandles();
        els.handles.textContent =
`minQ: ${h[0]}
minV: ${h[1]}
minI: ${h[2]}
bonusYes: ${h[3]}
bonusNo : ${h[4]}
exists : ${h[5]}`;
      }catch{}
    }catch(e){ err(els.admLog, e.message || String(e)); }
  };

  // ===== Admin: set encrypted policy =====
  els.btnSetEnc.onclick = async ()=>{
    try{
      if(!relayer || !contract) await els.btnConnect.onclick();

      const minQ = Number(els.minQ.value || 0);
      const minV = Number(els.minV.value || 0);
      const minI = Number(els.minI.value || 0);
      const bYes = Number(els.bYes.value || 0);
      const bNo  = Number(els.bNo.value  || 0);

      if(!isU8(minQ) || !isU8(minV) || !isU8(minI) || !isU32(bYes) || !isU32(bNo)) throw new Error("Out of range");

      info(els.admLog, "Encrypting policy…");
      const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, user);
      buf.add8(minQ);
      buf.add8(minV);
      buf.add8(minI);
      buf.add32(bYes);
      buf.add32(bNo);
      const { handles, inputProof } = await buf.encrypt();

      // staticCall (may fail on some RPCs; ok to fall through)
      try{ await contract.setPolicyEncrypted.staticCall(handles[0], handles[1], handles[2], handles[3], handles[4], inputProof); }catch{}

      const tx = await contract.setPolicyEncrypted(handles[0], handles[1], handles[2], handles[3], handles[4], inputProof);
      info(els.admLog, `TX: ${tx.hash}`);
      await tx.wait();
      ok(els.admLog, "Encrypted policy set ✓");

      const h = await contract.getPolicyHandles();
      els.handles.textContent =
`minQ: ${h[0]}
minV: ${h[1]}
minI: ${h[2]}
bonusYes: ${h[3]}
bonusNo : ${h[4]}
exists : ${h[5]}`;

    }catch(e){ err(els.admLog, e.message || String(e)); }
  };

  // ===== Admin: set plain policy (dev) =====
  els.btnSetPlain.onclick = async ()=>{
    try{
      if(!contract) await els.btnConnect.onclick();
      const minQ = Number(els.minQ.value || 0);
      const minV = Number(els.minV.value || 0);
      const minI = Number(els.minI.value || 0);
      const bYes = Number(els.bYes.value || 0);
      const bNo  = Number(els.bNo.value  || 0);
      if(!isU8(minQ) || !isU8(minV) || !isU8(minI) || !isU32(bYes) || !isU32(bNo)) throw new Error("Out of range");

      const tx = await contract.setPolicyPlain(minQ, minV, minI, bYes, bNo);
      info(els.admLog, `TX: ${tx.hash}`);
      await tx.wait();
      ok(els.admLog, "Plain policy set ✓");

      const h = await contract.getPolicyHandles();
      els.handles.textContent =
`minQ: ${h[0]}
minV: ${h[1]}
minI: ${h[2]}
bonusYes: ${h[3]}
bonusNo : ${h[4]}
exists : ${h[5]}`;

    }catch(e){ err(els.admLog, e.message || String(e)); }
  };

  // ===== Admin: make policy public (demo)
  els.btnPublic.onclick = async ()=>{
    try{
      if(!contract) await els.btnConnect.onclick();
      const tx = await contract.makePolicyPublic();
      info(els.admLog, `TX: ${tx.hash}`);
      await tx.wait();
      ok(els.admLog, "Policy marked public ✓");
    }catch(e){ err(els.admLog, e.message || String(e)); }
  };

  // ===== Employee: evaluate KPIs =====
  els.btnEval.onclick = async ()=>{
    try{
      if(!relayer || !contract) await els.btnConnect.onclick();

      const q = Number(els.q.value || 0);
      const v = Number(els.v.value || 0);
      const i = Number(els.i.value || 0);
      if(!isU8(q) || !isU8(v) || !isU8(i)) throw new Error("Inputs out of range");

      info(els.empLog, "Encrypting KPIs…");
      els.bonusOut.textContent = "$ —";

      const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, user);
      buf.add8(q);
      buf.add8(v);
      buf.add8(i);
      const { handles, inputProof } = await buf.encrypt();

      try{ await contract.evaluateKPIs.staticCall(handles[0], handles[1], handles[2], inputProof); }catch{}

      const tx = await contract.evaluateKPIs(handles[0], handles[1], handles[2], inputProof);
      els.empTx.textContent = tx.hash;
      info(els.empLog, "Waiting for receipt…");
      const rcpt = await tx.wait();

      // Parse BonusComputed(employee, bonusHandle)
      const iface = new Contract(CONTRACT_ADDRESS, abi, signer).interface;
      const topic = iface.getEvent("BonusComputed").topicHash;
      const log = rcpt.logs.find(l => l.topics?.[0] === topic);
      if(!log){ throw new Error("Event not found"); }
      const parsed = iface.parseLog(log);
      const handle = parsed.args.bonusHandle;

      info(els.empLog, "Decrypting bonus…");

      // EIP-712 userDecrypt (employee only)
      const kp = await generateKeypair();
      const startTs = Math.floor(Date.now()/1000).toString();
      const days = "7";
      const eip = relayer.createEIP712(kp.publicKey, [CONTRACT_ADDRESS], startTs, days);
      const sig = await signer.signTypedData(
        eip.domain,
        { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification },
        eip.message
      );

      const pairs = [{ handle, contractAddress: CONTRACT_ADDRESS }];
      const out = await relayer.userDecrypt(pairs, kp.privateKey, kp.publicKey, sig.replace("0x",""),
                                            [CONTRACT_ADDRESS], user, startTs, days);

      let val = out[handle];
      if(val === undefined){
        const k = Object.keys(out).find(k => k.toLowerCase() === handle.toLowerCase());
        val = k ? out[k] : undefined;
      }
      if(val === undefined) throw new Error("Decryption failed");

      // val is u32 (string/number/bigint). Normalize:
      const num = Number(val);
      if(Number.isFinite(num)){
        els.bonusOut.textContent = `$ ${num.toLocaleString()}`;
        ok(els.empLog, "Bonus decrypted ✓");
      }else{
        els.bonusOut.textContent = `$ ${String(val)}`;
        ok(els.empLog, "Bonus decrypted ✓ (non-numeric)");
      }
    }catch(e){ err(els.empLog, e.message || String(e)); }
  };

  // Network badge on load if wallet present
  (async ()=>{
    try{
      if(window.ethereum){
        const net = await (new BrowserProvider(window.ethereum)).getNetwork();
        els.netTag.textContent = net.chainId===11155111n ? "Network: Sepolia" : `Network: ${String(net.chainId)}`;
      }
    }catch{}
  })();
</script>
</body>
</html>
