<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- Required for Relayer WASM workers -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin"/>
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp"/>

  <title>Private Gas Cap · Zama FHEVM</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@600&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0b1017; --ink:#e5eefc; --muted:#92a5c7; --line:#1f2a3e;
      --panel:#0f1521; --panel2:#0c1322; --accent:#7cc9ff; --accent2:#8a7cff; --ok:#3bd7a7; --err:#ff7c98;
      --radius:16px; --shadow:0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--ink);
      background:
        radial-gradient(60vw 60vw at 110% -10%, rgba(135,110,255,.20), transparent 60%),
        radial-gradient(60vw 60vw at -10% -20%, rgba(64,186,255,.22), transparent 60%),
        linear-gradient(180deg,#0b1017,#0b1017);
    }
    header{
      position:sticky; top:0; z-index:10; padding:16px clamp(14px,3vw,28px);
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      background:linear-gradient(180deg,#0b1017,rgba(11,16,23,.75)); border-bottom:1px solid var(--line);
      backdrop-filter: blur(8px);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:42px; height:42px; border-radius:12px; display:grid; place-items:center; font-weight:900; letter-spacing:.25px;
      background:
        radial-gradient(60% 60% at 25% 20%, #1fe4ff55, transparent 60%),
        radial-gradient(60% 60% at 70% 75%, #9b8cff55, transparent 60%),
        #111a2a; box-shadow: inset 0 0 0 1px #1b2436;
    }
    h1{margin:0; font-size:18px; font-weight:800}
    .sub{font-size:12px; color:var(--muted); font-weight:600}

    .chip{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px;
      background:linear-gradient(90deg,#65d1ff,#9ab8ff); color:#05101d; font-weight:900; border:0; cursor:pointer;
      box-shadow: 0 10px 24px rgba(101,209,255,.28);
    }
    .meta{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .pill{font:700 12px "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      color:#d9e6ff; border:1px solid #25324a; background:#0c1322; padding:8px 12px; border-radius:999px; box-shadow: var(--shadow);
    }

    main{max-width:1180px; margin:28px auto 80px; padding:0 16px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:18px}
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{background:linear-gradient(180deg,#0f1521,#0b1120); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow: var(--shadow)}
    .card h2{margin:0 0 8px; font-size:16px; font-weight:800}

    label{display:block; margin:10px 0 6px; font-size:12px; color:#c7d5f1; font-weight:800; letter-spacing:.02em}
    input{width:100%; padding:12px 14px; border-radius:14px; border:1px solid #1e2940; background:#0d1424; color:#e8f1ff; font-weight:800; outline:none}
    input::placeholder{color:#7e8fb1}
    input:focus{box-shadow:0 0 0 6px rgba(120,178,255,.16), inset 0 0 0 1px #7cc9ff}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{appearance:none; border:0; border-radius:14px; padding:12px 14px; font-weight:900; cursor:pointer; color:#07111f; letter-spacing:.2px;
      background:linear-gradient(90deg,#62e7ff,#8e7dff); box-shadow:0 16px 40px rgba(98,231,255,.22)}
    .btn.alt{background:linear-gradient(90deg,#ffd58a,#ffe9ba); color:#111}

    .status{margin-top:10px; border-radius:12px; padding:12px; background:#0d1526; border:1px dashed #23314c;
      color:#b8c6e8; font:700 12px Inter, sans-serif; min-height:44px; display:flex; align-items:center; word-break:break-all}
    .status.ok{border-style:solid; color:#caffea; background:#0f221a}
    .status.err{border-style:solid; color:#ffd4dd; background:#1d0f14}

    .mono{font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight:700}
    .out{border:1px solid #1e2940; background:#0d1526; color:#e8f1ff; padding:10px 12px; border-radius:12px; display:inline-block; min-width:200px}
    small.dim{color:#7f92b9}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">FHE</div>
    <div>
      <h1>Private Gas Cap</h1>
      <div class="sub">Reject above-cap gas without revealing the secret threshold</div>
    </div>
  </div>
  <button id="btnConnect" class="chip">Link Wallet</button>
</header>

<main>
  <div class="meta" style="justify-content:space-between; margin-bottom:18px;">
    <div class="meta">
      <span class="pill">Contract</span>
      <span id="addr" class="pill">0xF78920466F1e88d231aAF5F01CA7b500C9b72F44</span>
      <span class="pill">Relayer SDK 0.2.0</span>
      <span class="pill">Ethers v6</span>
      <span id="ownerTag" class="pill">Owner: —</span>
    </div>
    <span id="netTag" class="pill">Network: —</span>
  </div>

  <section class="grid">
    <!-- Precheck -->
    <article class="card">
      <h2>Private gas precheck</h2>
      <p class="sub">We compute an encrypted verdict <b>(gasleft ≤ secret cap)</b> and let only you decrypt it.</p>

      <div class="row" style="margin-top:8px">
        <button id="btnPrecheck" class="btn">Run Encrypted Precheck</button>
        <span id="preTx" class="pill mono">—</span>
      </div>

      <div id="preLog" class="status">—</div>

      <div class="row" style="margin-top:10px">
        <span class="out mono" id="verdictOut">Verdict: —</span>
        <small class="dim mono" id="gasSnap">gasleft(): —</small>
      </div>
    </article>

    <!-- Owner tools & guarded execute -->
    <article class="card">
      <h2>Admin & Guarded execution</h2>
      <p class="sub">Dev: set plain secret cap. Then issue a Pass (EIP-712) and execute the protected action.</p>

      <label>Set secret cap (plain, dev only)</label>
      <div class="row">
        <input id="capPlain" type="number" min="0" max="4294967295" placeholder="e.g. 1_000_000 (gas left)"/>
        <button id="btnSetPlain" class="btn alt">Install Dev Cap</button>
      </div>
      <div id="admLog" class="status">—</div>

      <label style="margin-top:10px">Current cap handle</label>
      <div id="capHandle" class="status mono">—</div>

      <div style="height:1px;background:#202d45;margin:14px 0"></div>

      <h3 style="margin:0 0 6px;font-size:14px">Issue Pass (owner signs)</h3>
      <label>Deadline (unix seconds)</label>
      <input id="deadline" type="number" min="0" placeholder="e.g. now + 600"/>
      <div class="row" style="margin-top:10px">
        <button id="btnIssueSelf" class="btn">Issue Pass to Me</button>
        <button id="btnIssueClipboard" class="btn">Copy Signature JSON</button>
      </div>
      <div id="passLog" class="status">—</div>

      <h3 style="margin:12px 0 6px;font-size:14px">Execute guarded action</h3>
      <label>Paste signature JSON (v,r,s,deadline)</label>
      <input id="sigJson" type="text" placeholder='{"v":27,"r":"0x..","s":"0x..","deadline": 9999999999}'/>
      <div class="row" style="margin-top:10px">
        <button id="btnExec" class="btn">guardedExecute()</button>
        <span id="execTx" class="pill mono">—</span>
      </div>
      <div id="execLog" class="status">—</div>
    </article>
  </section>
</main>

<!-- SDKs -->
<script type="module" crossorigin src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js"></script>
<script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm"></script>

<script type="module">
  import { BrowserProvider, Contract } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";
  import { initSDK, createInstance, SepoliaConfig, generateKeypair } from "https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js";

  // ===== Config =====
  const CONTRACT_ADDRESS = "0xF78920466F1e88d231aAF5F01CA7b500C9b72F44";
  const RELAYER_URL = "https://relayer.testnet.zama.cloud";
  const CHAIN_ID_HEX = "0xaa36a7"; // Sepolia

  // ===== ABI =====
  const abi = [
    { type:"function", name:"version", inputs:[], outputs:[{type:"string"}], stateMutability:"pure" },
    { type:"function", name:"owner", inputs:[], outputs:[{type:"address"}], stateMutability:"view" },
    { type:"function", name:"setCapPlain", inputs:[{type:"uint32"}], outputs:[], stateMutability:"nonpayable" },
    { type:"function", name:"getCapHandle", inputs:[], outputs:[{type:"bytes32"}], stateMutability:"view" },
    { type:"function", name:"makeCapPublic", inputs:[], outputs:[], stateMutability:"nonpayable" },
    { type:"function", name:"precheckGas", inputs:[], outputs:[{type:"bytes1"}], stateMutability:"nonpayable" },
    { type:"function", name:"guardedExecute", inputs:[{type:"uint256"},{type:"uint8"},{type:"bytes32"},{type:"bytes32"}], outputs:[], stateMutability:"nonpayable" },
    { type:"event", name:"GasPrechecked", inputs:[
      {indexed:true, name:"caller", type:"address"},
      {indexed:false, name:"verdictHandle", type:"bytes32"},
      {indexed:false, name:"snapshotGasLeft", type:"uint256"}
    ] },
    { type:"event", name:"GasCapUpdated", inputs:[{indexed:false, name:"capHandle", type:"bytes32"}] },
    { type:"event", name:"GuardedExecuted", inputs:[{indexed:true, name:"caller", type:"address"},{indexed:false, name:"nonce", type:"uint256"}] },
  ];

  // ===== Elements =====
  const $ = (id)=>document.getElementById(id);
  const els = {
    netTag: $("netTag"), btnConnect: $("btnConnect"), addr: $("addr"), ownerTag: $("ownerTag"),
    btnPrecheck: $("btnPrecheck"), preLog: $("preLog"), preTx: $("preTx"), verdictOut: $("verdictOut"), gasSnap: $("gasSnap"),
    capPlain: $("capPlain"), btnSetPlain: $("btnSetPlain"), admLog: $("admLog"), capHandle: $("capHandle"),
    deadline: $("deadline"), btnIssueSelf: $("btnIssueSelf"), btnIssueClipboard: $("btnIssueClipboard"), passLog: $("passLog"),
    sigJson: $("sigJson"), btnExec: $("btnExec"), execLog: $("execLog"), execTx: $("execTx"),
  };
  els.addr.textContent = CONTRACT_ADDRESS;

  // ===== State =====
  let provider, signer, user, contract, relayer, chainId;

  // ===== Helpers =====
  const info = (el,t)=>{ el.className="status"; el.textContent=t; };
  const ok   = (el,t)=>{ el.className="status ok"; el.textContent=t; };
  const err  = (el,t)=>{ el.className="status err"; el.textContent=t; };
  const short = (a)=>a ? a.slice(0,6)+"…"+a.slice(-4) : "—";
  const nowSec = ()=> Math.floor(Date.now()/1000);

  async function connect(){
    if(!window.ethereum) throw new Error("MetaMask not found");
    provider = new BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const net = await provider.getNetwork();
    chainId = Number(net.chainId);
    els.netTag.textContent = chainId===11155111 ? "Network: Sepolia" : `Network: ${String(net.chainId)}`;
    if (net.chainId !== 11155111n){
      await provider.send("wallet_switchEthereumChain", [{ chainId: CHAIN_ID_HEX }]);
    }
    signer = await provider.getSigner();
    user = await signer.getAddress();
    contract = new Contract(CONTRACT_ADDRESS, abi, signer);
    els.btnConnect.textContent = "Linked: " + short(user);

    await initSDK();
    relayer = await createInstance({ ...SepoliaConfig, relayerUrl: RELAYER_URL, network: window.ethereum, debug: true });

    try{
      const o = await contract.owner();
      els.ownerTag.textContent = `Owner: ${short(o)} ${o.toLowerCase()===user.toLowerCase()?"(you)":""}`;
    }catch{ els.ownerTag.textContent = "Owner: n/a"; }

    try{ els.capHandle.textContent = String(await contract.getCapHandle()); }catch{}
  }

  els.btnConnect.onclick = connect;

  // ===== Private precheck =====
  els.btnPrecheck.onclick = async ()=>{
    try{
      if(!contract) await connect();
      info(els.preLog, "Sending precheck…");
      const tx = await contract.precheckGas();
      els.preTx.textContent = tx.hash;
      const rcpt = await tx.wait();

      // Parse GasPrechecked
      const topic = contract.interface.getEvent("GasPrechecked").topicHash;
      const log = rcpt.logs.find(l => l.topics?.[0] === topic);
      if(!log) throw new Error("GasPrechecked not found");
      const parsed = contract.interface.parseLog(log);
      const handle = parsed.args.verdictHandle;
      const snapshot = parsed.args.snapshotGasLeft;
      els.gasSnap.textContent = `gasleft(): ${snapshot}`;

      info(els.preLog, "Decrypting verdict…");
      // userDecrypt flow
      const kp = await generateKeypair();
      const startTs = String(nowSec());
      const days = "7";
      const eip = relayer.createEIP712(kp.publicKey, [CONTRACT_ADDRESS], startTs, days);
      const sig = await signer.signTypedData(
        eip.domain,
        { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification },
        eip.message
      );

      const out = await relayer.userDecrypt(
        [{ handle, contractAddress: CONTRACT_ADDRESS }],
        kp.privateKey, kp.publicKey, sig.replace("0x",""),
        [CONTRACT_ADDRESS], user, startTs, days
      );

      let v = out[handle];
      if(v===undefined){
        const k = Object.keys(out).find(k => k.toLowerCase() === handle.toLowerCase());
        v = k ? out[k] : undefined;
      }
      const yes = (v===true || v==="true" || v===1 || v==="1");
      els.verdictOut.textContent = yes ? "Verdict: OK ✅" : "Verdict: OVER CAP ❌";
      ok(els.preLog, "Done");
    }catch(e){ err(els.preLog, e?.message || String(e)); }
  };

  // ===== Admin: set cap (plain, dev) =====
  els.btnSetPlain.onclick = async ()=>{
    try{
      if(!contract) await connect();
      const v = Number(els.capPlain.value || 0);
      if(!Number.isInteger(v) || v<0 || v>0xFFFFFFFF) throw new Error("Enter uint32 (0..4294967295)");
      info(els.admLog, "Submitting setCapPlain…");
      const tx = await contract.setCapPlain(v);
      info(els.admLog, `TX: ${tx.hash}`);
      await tx.wait();
      ok(els.admLog, "Cap installed ✓");
      try{ els.capHandle.textContent = String(await contract.getCapHandle()); }catch{}
    }catch(e){ err(els.admLog, e?.shortMessage || e?.message || String(e)); }
  };

  // ===== EIP-712 Pass helpers (owner issues) =====
  function passDomain(){
    return { name: "PrivateGasCap", version: "1", chainId, verifyingContract: CONTRACT_ADDRESS };
  }
  const PassTypes = {
    GasPass: [
      { name: "contractAddr", type: "address" },
      { name: "caller",       type: "address" },
      { name: "nonce",        type: "uint256" },
      { name: "deadline",     type: "uint256" },
    ],
  };

  // We cannot read nonces mapping without ABI; user will just set a fresh deadline, and
  // contract will check and consume current nonce internally. For demo we assume correct nonce.
  // Owner signs a pass for current caller (user).

  els.btnIssueSelf.onclick = async ()=>{
    try{
      if(!contract) await connect();
      const deadline = Number(els.deadline.value || (nowSec()+600));
      const message = {
        contractAddr: CONTRACT_ADDRESS,
        caller: user,
        nonce: 0,          // placeholder; contract uses its own stored nonce
        deadline
      };
      const sig = await signer.signTypedData(passDomain(), PassTypes, message);
      const { v, r, s } = splitSig(sig);
      els.sigJson.value = JSON.stringify({ v, r, s, deadline });
      ok(els.passLog, "Pass signed for your address (paste below to execute)");
    }catch(e){ err(els.passLog, e?.message || String(e)); }
  };

  els.btnIssueClipboard.onclick = async ()=>{
    try{
      if(!contract) await connect();
      const toAddr = user; // you can change to any address here
      const deadline = Number(els.deadline.value || (nowSec()+600));
      const msg = { contractAddr: CONTRACT_ADDRESS, caller: toAddr, nonce: 0, deadline };
      const sig = await signer.signTypedData(passDomain(), PassTypes, msg);
      const { v, r, s } = splitSig(sig);
      const payload = JSON.stringify({ v, r, s, deadline });
      await navigator.clipboard.writeText(payload);
      ok(els.passLog, "Signature JSON copied to clipboard");
    }catch(e){ err(els.passLog, e?.message || String(e)); }
  };

  function splitSig(sigHex){
    const hex = sigHex.replace(/^0x/,'');
    const r = "0x" + hex.slice(0,64);
    const s = "0x" + hex.slice(64,128);
    let v = parseInt(hex.slice(128,130), 16);
    if (v < 27) v += 27;
    return { v, r, s };
  }

  // ===== Execute guarded action =====
  els.btnExec.onclick = async ()=>{
    try{
      if(!contract) await connect();
      const raw = (els.sigJson.value||"").trim();
      if(!raw) throw new Error("Paste the signature JSON first");
      let obj;
      try{ obj = JSON.parse(raw); }catch{ throw new Error("Invalid JSON"); }
      const { v, r, s, deadline } = obj || {};
      if (typeof v!=="number" || !/^0x[0-9a-fA-F]{64}$/.test(r||"") || !/^0x[0-9a-fA-F]{64}$/.test(s||"") || !Number.isInteger(deadline))
        throw new Error("JSON must contain { v:number, r:0x..64, s:0x..64, deadline:number }");
      info(els.execLog, "Submitting guardedExecute…");
      const tx = await contract.guardedExecute(deadline, v, r, s);
      els.execTx.textContent = tx.hash;
      await tx.wait();
      ok(els.execLog, "Guarded action executed ✓");
    }catch(e){ err(els.execLog, e?.shortMessage || e?.message || String(e)); }
  };

  // Paint network badge on load
  (async ()=>{ try{
    if(window.ethereum){
      const net = await (new BrowserProvider(window.ethereum)).getNetwork();
      els.netTag.textContent = net.chainId===11155111n ? "Network: Sepolia" : `Network: ${String(net.chainId)}`;
    }
  }catch{} })();
</script>
</body>
</html>
