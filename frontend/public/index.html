<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Private Event Eligibility · Zama FHEVM</title>
  <style>
    :root{
      --bg:#0f1117; --panel:#151a24; --ink:#e8eef8; --muted:#8aa0b2;
      --line:#223049; --accent:#5eead4; --accent2:#60a5fa; --warn:#f59e0b; --good:#22c55e; --bad:#ef4444;
      --chip:#0d1726; --br:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{
      background:radial-gradient(1200px 800px at 20% -10%, rgba(96,165,250,.08), transparent),
                 radial-gradient(1000px 700px at 110% 10%, rgba(94,234,212,.08), transparent),
                 var(--bg);
      color:var(--ink); font:16px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif
    }
    .wrap{max-width:1120px;margin:26px auto;padding:0 16px}
    header.top{display:flex;gap:14px;align-items:center;margin-bottom:18px;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px}
    .logoMark{width:30px;height:30px;border-radius:10px;background:conic-gradient(from 180deg,#5eead4,#60a5fa,#5eead4)}
    .badge{background:var(--chip); border:1px solid var(--line); color:var(--muted);
           border-radius:999px; padding:8px 12px; font-size:12px}
    .btn{appearance:none;border:0;cursor:pointer;border-radius:12px;padding:10px 14px;
         color:#0b1220;background:linear-gradient(180deg,#7dd3fc,#60a5fa); font-weight:800}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.alt{background:linear-gradient(180deg,#34d399,#22c55e)}
    .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
    .grid{display:grid;grid-template-columns: 1.1fr .9fr; gap:18px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)), #151a24;
          border:1px solid var(--line); border-radius:var(--br); box-shadow:var(--shadow); padding:18px}
    h2{margin:0 0 10px 0; font-size:18px}
    p.lead{margin:0 0 12px 0; color:var(--muted)}
    label{display:block; color:var(--muted); font-weight:700; font-size:12px; letter-spacing:.6px; text-transform:uppercase; margin-bottom:8px}
    input, select{width:100%; background:#0b1220; border:1px solid var(--line); color:var(--ink); border-radius:12px; padding:12px; outline:none}
    input:focus, select:focus{border-color:#3b82f6; box-shadow:0 0 0 4px rgba(59,130,246,.15)}
    .row{display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap}
    .hint{color:var(--muted); font-size:12px}
    .line{height:6px; border-radius:999px; background:#0b1220; border:1px solid var(--line); overflow:hidden}
    .line>span{display:block; height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#5eead4)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .handles{font-size:12px; background:#0b1220; border:1px dashed var(--line); padding:10px; border-radius:10px; color:#c7d7e6; word-break:break-all}
    .status{min-height:20px;color:var(--muted); font-size:13px}
    .log{background:#0b1220; border:1px solid var(--line); border-radius:12px; padding:10px; height:180px; overflow:auto; font-size:12px}
    .twocol{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:640px){ .twocol{grid-template-columns:1fr} }
  </style>
</head>
<body>
<main class="wrap">
  <header class="top">
    <div class="logo">
      <div class="logoMark"></div>
      <div>
        <div>Private Event Eligibility</div>
        <div class="hint">Zama FHEVM · Encrypted checks only</div>
      </div>
    </div>
    <span id="netBadge" class="badge">Network: —</span>
    <span id="addrBadge" class="badge">Contract: —</span>
    <button id="btnConnect" class="btn" style="margin-left:auto">Connect Wallet</button>
  </header>

  <section class="grid">
    <article class="card">
      <h2>Register Privately</h2>
      <p class="lead">Age, country (ISO-3166 numeric), and invite flag are encrypted in one shot; the contract stores only your encrypted eligibility.</p>

      <div class="twocol">
        <div>
          <label>Age (years)</label>
          <input id="age" type="number" min="0" placeholder="e.g. 25">
        </div>
        <div>
          <label>Country (ISO numeric)</label>
          <input id="country" type="number" min="0" placeholder="e.g. 840 = US">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <label>Invite Flag</label>
          <select id="invite">
            <option value="1">1 — I have an invitation</option>
            <option value="0">0 — No invitation</option>
          </select>
        </div>
        <button id="btnRegister" class="btn alt">Submit Encrypted</button>
      </div>
      <div class="status" id="regStatus">—</div>
      <div class="line"><span id="regLine"></span></div>

      <div style="margin-top:14px">
        <label>My Eligibility Handle</label>
        <div class="row">
          <button id="btnGetHandle" class="btn ghost">Get Handle</button>
          <button id="btnPublicDecrypt" class="btn ghost">Public Decrypt</button>
          <button id="btnUserDecrypt" class="btn ghost">User Decrypt</button>
        </div>
        <div class="handles mono" id="myHandle">—</div>
        <div class="status" id="decStatus"></div>
      </div>
    </article>

    <article class="card">
      <h2>Owner · Policy</h2>
      <p class="lead">Set age threshold, whether an invite is required, and an allowlist of countries.</p>

      <div class="twocol">
        <div>
          <label>Event ID (bytes32 hex)</label>
          <input id="eventId" placeholder="0x... (leave empty to use default)">
        </div>
        <div>
          <label>Min Age</label>
          <input id="minAge" type="number" min="0" placeholder="e.g. 21">
        </div>
      </div>

      <div class="twocol" style="margin-top:10px">
        <div>
          <label>Require Invite</label>
          <select id="requireInvite">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </div>
        <div>
          <label>Allow Countries (comma)</label>
          <input id="countries" placeholder="e.g. 840,124,380">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnSetPolicy" class="btn">Set Policy</button>
        <button id="btnMakePublic" class="btn ghost">Make My Eligibility Public</button>
      </div>
      <div class="status" id="polStatus">—</div>

      
    </article>
  </section>

  <footer style="margin:18px 0; color:#8aa0b2; text-align:center">
    Relayer SDK 0.2.0 · Ethers v6 · Sepolia
  </footer>
</main>

<script type="module" crossorigin src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js"></script>
<script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm"></script>

<script type="module">
  import { BrowserProvider, Contract, getAddress } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";
  import { initSDK, createInstance, SepoliaConfig, generateKeypair } from "https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js";

  const CONTRACT_ADDRESS = "0x6eF4EB5101C4D442414f07C51E8C978eF997B2A5";
  const RELAYER_URL = "https://relayer.testnet.zama.cloud";
  const DEFAULT_EVENT_ID = "0x0000000000000000000000000000000000000000000000000000000000000045";
  const CHAIN_ID_HEX = "0xaa36a7";

  const ABI = [
    { inputs: [], name: "version", outputs: [{type:"string"}], stateMutability: "pure", type:"function" },
    { inputs: [{type:"bytes32"},{type:"uint16"},{type:"bool"},{type:"uint16[]"}], name:"setPolicy", outputs:[], stateMutability:"nonpayable", type:"function" },
    { inputs: [{type:"bytes32"}], name:"getPolicy", outputs:[{type:"bool"},{type:"uint16"},{type:"bool"},{type:"uint16[]"}], stateMutability:"view", type:"function" },
    { inputs: [{type:"bytes32"},{type:"bytes32"},{type:"bytes32"},{type:"bytes32"},{type:"bytes"}], name:"register", outputs:[{type:"bytes32"}], stateMutability:"nonpayable", type:"function" },
    { inputs: [{type:"bytes32"}], name:"getMyEligibilityHandle", outputs:[{type:"bytes32"}], stateMutability:"view", type:"function" },
    { inputs: [{type:"bytes32"}], name:"makeMyEligibilityPublic", outputs:[], stateMutability:"nonpayable", type:"function" },
    { inputs: [], name:"owner", outputs:[{type:"address"}], stateMutability:"view", type:"function" }
  ];

  const $ = s => document.querySelector(s);
  const netBadge = $("#netBadge");
  const addrBadge = $("#addrBadge");
  const btnConnect = $("#btnConnect");

  const age = $("#age");
  const country = $("#country");
  const invite = $("#invite");
  const btnRegister = $("#btnRegister");
  const regStatus = $("#regStatus");
  const regLine = $("#regLine");

  const btnGetHandle = $("#btnGetHandle");
  const btnPublicDecrypt = $("#btnPublicDecrypt");
  const btnUserDecrypt = $("#btnUserDecrypt");
  const myHandle = $("#myHandle");
  const decStatus = $("#decStatus");

  const eventIdIn = $("#eventId");
  const minAge = $("#minAge");
  const requireInvite = $("#requireInvite");
  const countries = $("#countries");
  const btnSetPolicy = $("#btnSetPolicy");
  const btnMakePublic = $("#btnMakePublic");
  const polStatus = $("#polStatus");

  const logBox = $("#log");

  netBadge.textContent = "Network: Sepolia";
  addrBadge.textContent = "Contract: " + short(CONTRACT_ADDRESS);

  let provider, signer, user, contract, relayer;

  function short(a){ return a ? a.slice(0,6)+"…"+a.slice(-4) : "—"; }

  // SAFE logger: не падает, если блока логов нет
  function log(...args){
    console.log("[UI]", ...args);
    if (!logBox) return;
    const s = args.map(x => typeof x === "string" ? x : JSON.stringify(x)).join(" ");
    const p = document.createElement("div");
    p.textContent = s;
    logBox.appendChild(p);
    logBox.scrollTop = logBox.scrollHeight;
  }

  function setBar(el, pct){ if(el) el.style.width = `${Math.max(0, Math.min(100, pct))}%`; }

  async function connect(){
    if(!window.ethereum) throw new Error("Install MetaMask");
    provider = new BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const net = await provider.getNetwork();
    if(net.chainId !== 11155111n){
      await provider.send("wallet_switchEthereumChain", [{ chainId: CHAIN_ID_HEX }]);
    }
    signer = await provider.getSigner();
    user = await signer.getAddress();
    contract = new Contract(getAddress(CONTRACT_ADDRESS), ABI, signer);
    btnConnect.textContent = short(user);
    log("Connected:", user);

    await initSDK();
    relayer = await createInstance({ ...SepoliaConfig, relayerUrl: RELAYER_URL, network: window.ethereum, debug: true });
    log("Relayer ready:", RELAYER_URL);

    // owner() может отсутствовать — тихо игнорим
    try{
      const owner = await contract.owner();
      log("Owner:", owner, owner && owner.toLowerCase()===user.toLowerCase() ? "(you)" : "");
    }catch{}
  }

  btnConnect.addEventListener("click", ()=>connect().catch(e=>alert(e.message||e)));

  // REGISTER (encrypted triple)
  btnRegister.addEventListener("click", async ()=>{
    try{
      if(!relayer || !contract) await connect();

      const a = BigInt(isFinite(+age.value)? +age.value : 0);
      const c = BigInt(isFinite(+country.value)? +country.value : 0);
      const i = BigInt(invite.value === "1" ? 1 : 0);
      const evId = eventIdIn.value && /^0x[0-9a-fA-F]{64}$/.test(eventIdIn.value) ? eventIdIn.value : DEFAULT_EVENT_ID;

      log("Encrypt triple:", {age: a.toString(), country: c.toString(), invite: i.toString()});
      regStatus.textContent = "Encrypting…"; setBar(regLine, 25);

      const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, user);
      if (typeof buf.add16 === "function") { buf.add16(a); buf.add16(c); } else { buf.addUint16(a); buf.addUint16(c); }
      if (typeof buf.add8  === "function") { buf.add8(i); }  else { buf.addUint8(i); }

      const { handles, inputProof } = await buf.encrypt();
      const [hAge, hCountry, hInvite] = handles;
      log("handles:", handles);

      setBar(regLine, 55);
      await contract.register.staticCall(evId, hAge, hCountry, hInvite, inputProof);
      setBar(regLine, 75);

      const tx = await contract.register(evId, hAge, hCountry, hInvite, inputProof);
      regStatus.textContent = "TX: " + tx.hash;
      await tx.wait();
      setBar(regLine, 100);
      regStatus.textContent = "✓ Registered";
    }catch(e){
      log("ERR register:", e);
      regStatus.textContent = "Error: " + (e.reason||e.message||String(e));
      setBar(regLine, 0);
    }
  });

  // HANDLE + DECRYPT
  btnGetHandle.addEventListener("click", async ()=>{
    try{
      if(!contract) await connect();
      const evId = eventIdIn.value && /^0x[0-9a-fA-F]{64}$/.test(eventIdIn.value) ? eventIdIn.value : DEFAULT_EVENT_ID;
      const h = await contract.getMyEligibilityHandle(evId);
      myHandle.textContent = String(h);
      decStatus.textContent = "Handle ready";
      log("handle:", h);
    }catch(e){
      decStatus.textContent = "Error: " + (e.reason||e.message||String(e));
    }
  });

  btnPublicDecrypt.addEventListener("click", async ()=>{
    try{
      if(!relayer || !contract) await connect();
      const evId = eventIdIn.value && /^0x[0-9a-fA-F]{64}$/.test(eventIdIn.value) ? eventIdIn.value : DEFAULT_EVENT_ID;
      const h = await contract.getMyEligibilityHandle(evId);
      const out = await relayer.publicDecrypt([h]);
      const v = Array.isArray(out) ? out[0] : (out[h] ?? out[Object.keys(out).find(k=>k.toLowerCase()===String(h).toLowerCase())]);
      const ok = (v===true || v==="true" || v===1 || v==="1");
      decStatus.innerHTML = ok ? "✅ Eligible" : "⚠️ Not eligible";
      log("publicDecrypt:", v);
    }catch(e){
      decStatus.textContent = "Error: " + (e.reason||e.message||String(e));
    }
  });

  btnUserDecrypt.addEventListener("click", async ()=>{
    try{
      if(!relayer || !contract) await connect();
      const evId = eventIdIn.value && /^0x[0-9a-fA-F]{64}$/.test(eventIdIn.value) ? eventIdIn.value : DEFAULT_EVENT_ID;
      const h = await contract.getMyEligibilityHandle(evId);

      const kp = await generateKeypair();
      const startTs = Math.floor(Date.now()/1000).toString();
      const days = "7";
      const eip = relayer.createEIP712(kp.publicKey, [CONTRACT_ADDRESS], startTs, days);
      const sig = await signer.signTypedData(
        eip.domain,
        { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification },
        eip.message
      );

      const out = await relayer.userDecrypt(
        [{ handle: h, contractAddress: CONTRACT_ADDRESS }],
        kp.privateKey, kp.publicKey, sig.replace(/^0x/, ""),
        [CONTRACT_ADDRESS], user, startTs, days
      );
      const v = out[h] ?? out[Object.keys(out).find(k=>k.toLowerCase()===String(h).toLowerCase())];
      const ok = (v===true || v==="true" || v===1 || v==="1");
      decStatus.innerHTML = ok ? "✅ Eligible" : "⚠️ Not eligible";
      log("userDecrypt:", v);
    }catch(e){
      decStatus.textContent = "Error: " + (e.reason||e.message||String(e));
    }
  });

  // OWNER
  btnSetPolicy.addEventListener("click", async ()=>{
    try{
      if(!contract) await connect();
      const evId = eventIdIn.value && /^0x[0-9a-fA-F]{64}$/.test(eventIdIn.value) ? eventIdIn.value : DEFAULT_EVENT_ID;
      const min = parseInt(minAge.value || "0");
      const req = requireInvite.value === "true";
      const arr = (countries.value||"").split(",").map(s=>s.trim()).filter(Boolean).map(x=>parseInt(x,10));
      log("setPolicy:", {eventId:evId, minAge:min, requireInvite:req, countries:arr});
      const tx = await contract.setPolicy(evId, min, req, arr);
      polStatus.textContent = "TX: " + tx.hash;
      await tx.wait();
      polStatus.textContent = "✓ Policy updated";
    }catch(e){
      polStatus.textContent = "Error: " + (e.reason||e.message||String(e));
    }
  });

  btnMakePublic.addEventListener("click", async ()=>{
    try{
      if(!contract) await connect();
      const evId = eventIdIn.value && /^0x[0-9a-fA-F]{64}$/.test(eventIdIn.value) ? eventIdIn.value : DEFAULT_EVENT_ID;
      const tx = await contract.makeMyEligibilityPublic(evId);
      polStatus.textContent = "TX: " + tx.hash;
      await tx.wait();
      polStatus.textContent = "✓ Marked public (your eligibility)";
      log("made public for", short(user));
    }catch(e){
      polStatus.textContent = "Error: " + (e.reason||e.message||String(e));
    }
  });
</script>
</body>
</html>
